<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Femud</title>

  <meta name="theme-color" content="#0b1220" />
  <meta name="description" content="Femud – BİST analiz + Dolar/Euro/Altın/Gümüş pano (PWA)" />

  <!-- iPhone PWA ayarları -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Femud" />

  <!-- PWA Manifest (tek dosya: data URL) -->
  <link rel="manifest" id="manifestLink" />
  <link rel="apple-touch-icon" id="appleIcon" />

  <!-- Grafik (Chart.js) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#111827; --line:#1f2937; --text:#e5e7eb; --muted:#94a3b8;
      --blue:#2563eb; --green:#16a34a; --amber:#f59e0b; --red:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}
    header{
      position:sticky; top:0; z-index:10;
      padding:14px 16px 12px;
      background:linear-gradient(180deg,#0f172a 0%, #0b1220 100%);
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .brandLeft{display:flex; align-items:center; gap:10px}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(135deg,#22c55e,#2563eb);
      display:grid; place-items:center; font-weight:900; color:#fff;
      box-shadow:0 10px 25px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    h1{margin:0; font-size:18px; letter-spacing:1.2px}
    .sub{margin-top:4px; font-size:12px; color:var(--muted)}
    main{max-width:1100px; margin:0 auto; padding:16px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:12px 0 2px}
    .tabbtn{
      border:1px solid var(--line); background:rgba(17,24,39,.6); color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700; font-size:13px;
    }
    .tabbtn.active{background:rgba(37,99,235,.25); border-color:rgba(37,99,235,.55)}
    .card{background:rgba(17,24,39,.7); border:1px solid var(--line); border-radius:14px; padding:12px; margin:12px 0}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start}
    .grow{flex:1}
    .btn{
      background:var(--blue); color:#fff; border:0; border-radius:12px;
      padding:10px 12px; cursor:pointer; font-weight:800;
      white-space:nowrap;
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .ghost{background:transparent; border:1px solid var(--line); color:var(--text)}
    .danger{background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.35); color:#fecaca}
    input,select,textarea{
      background:rgba(17,24,39,.7); border:1px solid var(--line); color:var(--text);
      padding:10px 12px; border-radius:12px; outline:none;
    }
    input[type=file]{padding:10px}
    textarea{width:100%; min-height:90px; resize:vertical}
    .tag{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:900; border:1px solid transparent}
    .tag.al{background:rgba(22,163,74,.15); border-color:rgba(22,163,74,.35); color:#86efac}
    .tag.bekle{background:rgba(245,158,11,.15); border-color:rgba(245,158,11,.35); color:#fde68a}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    th,td{padding:10px; border-bottom:1px solid var(--line); font-size:13px}
    th{background:#0f172a; text-align:left}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:960px){ .grid{grid-template-columns:1fr 1fr} }
    .kpi{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .kpi .pill{border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted)}
    canvas{background:rgba(2,6,23,.15); border-radius:14px; border:1px solid var(--line)}
    .hr{height:1px; background:var(--line); margin:10px 0}
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="brandLeft">
      <div class="logo">F</div>
      <div>
        <h1>FEMUD</h1>
        <div class="sub">BİST Analiz (CSV) + Dolar/Euro/Altın/Gümüş Pano • 1 hafta • seçici</div>
      </div>
    </div>

    <button id="refreshAll" class="btn" title="Tüm verileri güncelle">
      Bilgileri Güncelle
    </button>
  </div>

  <div class="tabs">
    <button class="tabbtn active" data-tab="markets">Piyasalar</button>
    <button class="tabbtn" data-tab="bist">BİST Analiz</button>
    <button class="tabbtn" data-tab="settings">Ayarlar</button>
  </div>
</header>

<main>
  <!-- MARKETS -->
  <section id="tab-markets">
    <div class="card">
      <b>Dolar / Euro / Altın / Gümüş</b>
      <div class="small muted" style="margin-top:6px">
        USD/EUR: Frankfurter (ECB referanslı) • Altın/Gümüş: manuel (istersen ayarlardan değer gir).
      </div>
      <div class="kpi" id="kpiRow"></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div class="grow"><b>USD/TRY (Dolar)</b><div class="small muted">Son 30 gün</div></div>
        </div>
        <canvas id="chartUsdTry" height="140"></canvas>
        <div class="hr"></div>
        <div id="usdTryNotes" class="small muted"></div>
      </div>

      <div class="card">
        <div class="row">
          <div class="grow"><b>EUR/TRY (Euro)</b><div class="small muted">Son 30 gün</div></div>
        </div>
        <canvas id="chartEurTry" height="140"></canvas>
        <div class="hr"></div>
        <div id="eurTryNotes" class="small muted"></div>
      </div>

      <div class="card">
        <div class="row">
          <div class="grow"><b>Altın (TRY)</b><div class="small muted">Manuel değer (Ayarlar)</div></div>
        </div>
        <canvas id="chartGold" height="140"></canvas>
        <div class="hr"></div>
        <div id="goldNotes" class="small muted"></div>
      </div>

      <div class="card">
        <div class="row">
          <div class="grow"><b>Gümüş (TRY)</b><div class="small muted">Manuel değer (Ayarlar)</div></div>
        </div>
        <canvas id="chartSilver" height="140"></canvas>
        <div class="hr"></div>
        <div id="silverNotes" class="small muted"></div>
      </div>
    </div>

    <div class="card">
      <b>Not</b>
      <div class="small muted">
        Bu uygulama yatırım tavsiyesi değildir. “Kesin kâr” vermez. Grafikten türetilen trend/oynaklık özeti ve disiplinli plan sunar.
      </div>
    </div>
  </section>

  <!-- BIST -->
  <section id="tab-bist" style="display:none">
    <div class="card">
      <b>BİST Analiz (1 hafta • seçici • CSV ile)</b>
      <div class="small muted">
        Herkes kendi CSV’sini yükler → uygulama 2 yıllık kanıt + AL/BEKLE + giriş/stop/hedef üretir.
      </div>
      <div class="hr"></div>

      <div class="row">
        <div class="grow">
          <div class="small muted">CSV kolonları: <span class="mono">date,open,high,low,close,volume</span> • Dosya adı sembol: <span class="mono">ANSGR.csv</span></div>
          <input id="bistFiles" type="file" accept=".csv" multiple />
        </div>
        <button id="bistRun" class="btn" disabled>Tarama Yap</button>
        <button id="bistClear" class="btn ghost">Temizle</button>
      </div>

      <div id="bistStatus" class="small muted" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <b>En güçlü 3–6 aday</b>
      <div id="bistTop"></div>
    </div>

    <div id="bistDetails"></div>
  </section>

  <!-- SETTINGS -->
  <section id="tab-settings" style="display:none">
    <div class="card">
      <b>Ayarlar</b>
      <div class="small muted" style="margin-top:6px">Altın/Gümüş için manuel değer gir (TRY).</div>
      <div class="hr"></div>

      <div class="row">
        <div class="grow">
          <label class="small muted">Manuel Altın (TRY)</label><br/>
          <input id="manualGold" placeholder="Örn: 2100.50" />
        </div>
        <div class="grow">
          <label class="small muted">Manuel Gümüş (TRY)</label><br/>
          <input id="manualSilver" placeholder="Örn: 24.30" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="saveSettings" class="btn">Kaydet</button>
        <button id="resetSettings" class="btn ghost danger">Sıfırla</button>
      </div>

      <div class="hr"></div>
      <b>Kurulum</b>
      <div class="small muted">
        Bu dosyayı bir web adresine koyduğunda her telefondan açılır. Sonra telefonda “Ana Ekrana Ekle” ile Femud gibi çalışır.
      </div>
    </div>
  </section>
</main>

<script>
/* =========================
   PWA Manifest + Icon (tek dosya)
========================= */
(function initPWA(){
  const iconSvg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#22c55e"/>
        <stop offset="1" stop-color="#2563eb"/>
      </linearGradient>
    </defs>
    <rect x="0" y="0" width="512" height="512" rx="96" fill="url(#g)"/>
    <text x="50%" y="56%" text-anchor="middle" font-size="220" font-weight="900" font-family="system-ui, -apple-system, Segoe UI, Roboto" fill="#fff">F</text>
  </svg>`;
  const iconData = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(iconSvg);
  document.getElementById("appleIcon").setAttribute("href", iconData);

  const manifest = {
    name: "Femud",
    short_name: "Femud",
    start_url: ".",
    display: "standalone",
    background_color: "#0b1220",
    theme_color: "#0b1220",
    icons: [{ src: iconData, sizes: "512x512", type: "image/svg+xml" }]
  };
  const manifestData = "data:application/manifest+json;charset=utf-8," + encodeURIComponent(JSON.stringify(manifest));
  document.getElementById("manifestLink").setAttribute("href", manifestData);
})();

/* =========================
   Tabs
========================= */
document.querySelectorAll(".tabbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const t = btn.dataset.tab;
    document.getElementById("tab-markets").style.display = (t==="markets") ? "" : "none";
    document.getElementById("tab-bist").style.display = (t==="bist") ? "" : "none";
    document.getElementById("tab-settings").style.display = (t==="settings") ? "" : "none";
  });
});

/* =========================
   Settings storage
========================= */
const SKEY="femud_settings_v1";
function loadSettings(){
  try{ return JSON.parse(localStorage.getItem(SKEY) || "{}"); }catch(e){ return {}; }
}
function saveSettingsObj(obj){
  localStorage.setItem(SKEY, JSON.stringify(obj));
}
function resetSettingsObj(){
  localStorage.removeItem(SKEY);
}
function applySettingsToUI(){
  const s = loadSettings();
  document.getElementById("manualGold").value = s.manualGold || "";
  document.getElementById("manualSilver").value = s.manualSilver || "";
}
applySettingsToUI();

document.getElementById("saveSettings").addEventListener("click", ()=>{
  const obj = {
    manualGold: (document.getElementById("manualGold").value || "").trim(),
    manualSilver: (document.getElementById("manualSilver").value || "").trim()
  };
  saveSettingsObj(obj);
  alert("Kaydedildi. Şimdi 'Bilgileri Güncelle' ile grafikleri yenile.");
});

document.getElementById("resetSettings").addEventListener("click", ()=>{
  if(confirm("Ayarlar sıfırlansın mı?")){
    resetSettingsObj();
    applySettingsToUI();
    alert("Sıfırlandı.");
  }
});

/* =========================
   MARKETS: USD/TRY, EUR/TRY from Frankfurter (ECB)
   Frankfurter base EUR. EUR/TRY direct, USD/TRY = (EUR->TRY) / (EUR->USD)
========================= */
let chartUsdTry=null, chartEurTry=null, chartGold=null, chartSilver=null;

function mkChart(canvasId, labels, data){
  const ctx = document.getElementById(canvasId);
  return new Chart(ctx, {
    type: "line",
    data: { labels, datasets: [{ label: "", data, tension: 0.25, pointRadius: 0 }] },
    options: {
      responsive: true,
      plugins:{ legend:{ display:false } },
      scales:{ x:{ ticks:{ maxTicksLimit: 6 } }, y:{ ticks:{ maxTicksLimit: 6 } } }
    }
  });
}

function pctChange(a,b){
  if(a===0 || a==null || b==null) return null;
  return (b/a)-1;
}

function buildNotes(series){
  if(series.length < 5) return "Yetersiz veri.";
  const first = series[0], last = series[series.length-1];
  const ch = pctChange(first,last);
  const daily = [];
  for(let i=1;i<series.length;i++) daily.push(series[i]-series[i-1]);
  const avgAbs = daily.reduce((a,b)=>a+Math.abs(b),0)/daily.length;
  const direction = ch>0 ? "yukarı" : (ch<0 ? "aşağı" : "yatay");

  const plan =
    ch>0
      ? "Trend yukarı. 1 haftalık disiplin: geri çekilmelerde kademeli yaklaşım + net stop."
      : (ch<0
          ? "Trend aşağı. 1 haftalık disiplin: acele alım yok; dönüş teyidi (kırılım) bekle."
          : "Yatay. 1 haftalık disiplin: bant kırılımı olmadan agresif işlem yapma.");

  const drivers = [
    "Faiz beklentileri / risk iştahı",
    "Jeopolitik haber akışı",
    "Küresel dolar endeksi ve emtia etkileri"
  ];

  return `
    <b>Özet:</b> Son 30 günde <b>${direction}</b> (${(ch*100).toFixed(2)}%).<br/>
    <b>Oynaklık:</b> Ortalama günlük hareket ~ <b>${avgAbs.toFixed(4)}</b> (birim).<br/>
    <b>Plan:</b> ${plan}<br/>
    <b>Muhtemel etkenler:</b> ${drivers.join(" • ")}
  `;
}

async function fetchFrankfurterTimeSeries(){
  const end = new Date();
  const start = new Date(end.getTime() - 35*24*3600*1000);
  const fmt = d => d.toISOString().slice(0,10);

  const url = `https://api.frankfurter.dev/${fmt(start)}..${fmt(end)}?from=EUR&to=TRY,USD`;
  const r = await fetch(url);
  if(!r.ok) throw new Error("Frankfurter API hatası");
  return await r.json();
}

function safeNum(x){ const n = Number(x); return Number.isFinite(n) ? n : null; }

function setKpi(kpis){
  const el = document.getElementById("kpiRow");
  el.innerHTML = "";
  for(const k of kpis){
    el.innerHTML += `<div class="pill"><b>${k.label}</b>: ${k.value}</div>`;
  }
}

async function refreshMarkets(){
  const js = await fetchFrankfurterTimeSeries();
  const rates = js.rates;
  const dates = Object.keys(rates).sort();

  const eurTry = dates.map(d => safeNum(rates[d].TRY));
  const eurUsd = dates.map(d => safeNum(rates[d].USD));
  const usdTry = dates.map((_,i) => (eurTry[i] && eurUsd[i]) ? (eurTry[i]/eurUsd[i]) : null);

  if(chartUsdTry) chartUsdTry.destroy();
  if(chartEurTry) chartEurTry.destroy();
  chartUsdTry = mkChart("chartUsdTry", dates, usdTry);
  chartEurTry = mkChart("chartEurTry", dates, eurTry);

  document.getElementById("usdTryNotes").innerHTML = buildNotes(usdTry.filter(v=>v!=null));
  document.getElementById("eurTryNotes").innerHTML = buildNotes(eurTry.filter(v=>v!=null));

  // Manual metals (flat series on same dates)
  const s = loadSettings();
  const mg = safeNum(s.manualGold);
  const ms = safeNum(s.manualSilver);

  const goldSeries = dates.map(_=>mg);
  const silverSeries = dates.map(_=>ms);

  if(chartGold) chartGold.destroy();
  if(chartSilver) chartSilver.destroy();
  chartGold = mkChart("chartGold", dates, goldSeries);
  chartSilver = mkChart("chartSilver", dates, silverSeries);

  document.getElementById("goldNotes").innerHTML = mg
    ? buildNotes(goldSeries.filter(v=>v!=null))
    : "Altın için Ayarlar’dan manuel fiyat gir, sonra 'Bilgileri Güncelle'.";

  document.getElementById("silverNotes").innerHTML = ms
    ? buildNotes(silverSeries.filter(v=>v!=null))
    : "Gümüş için Ayarlar’dan manuel fiyat gir, sonra 'Bilgileri Güncelle'.";

  const lastUsdTry = usdTry[usdTry.length-1];
  const lastEurTry = eurTry[eurTry.length-1];
  const t = new Date().toLocaleString("tr-TR");

  setKpi([
    {label:"USD/TRY", value: lastUsdTry ? lastUsdTry.toFixed(4) : "-"},
    {label:"EUR/TRY", value: lastEurTry ? lastEurTry.toFixed(4) : "-"},
    {label:"Altın (TRY)", value: mg ? mg.toFixed(2) : "-"},
    {label:"Gümüş (TRY)", value: ms ? ms.toFixed(2) : "-"},
    {label:"Son Güncelleme", value: t}
  ]);
}

/* =========================
   BIST CSV ANALYZER (Seçici, 1 hafta) - offline
========================= */
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const header = lines[0].split(',').map(s=>s.trim());
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const parts = lines[i].split(',').map(s=>s.trim());
    const obj = {};
    for(let j=0;j<header.length;j++) obj[header[j]] = parts[j];
    rows.push(obj);
  }
  return rows;
}
function toNum(x){ const v = Number(x); return Number.isFinite(v) ? v : null; }
function ema(values, period){
  const k=2/(period+1);
  const out=[]; let prev=values[0];
  out.push(prev);
  for(let i=1;i<values.length;i++){ const v=values[i]*k + prev*(1-k); out.push(v); prev=v; }
  return out;
}
function rsi(values, period=14){
  const out=new Array(values.length).fill(50);
  let gains=0, losses=0;
  for(let i=1;i<=period && i<values.length;i++){
    const d=values[i]-values[i-1]; if(d>=0) gains+=d; else losses+=-d;
  }
  let avgGain=gains/period, avgLoss=losses/period;
  out[period]=avgLoss===0?70:100-(100/(1+(avgGain/avgLoss)));
  for(let i=period+1;i<values.length;i++){
    const d=values[i]-values[i-1];
    const gain=d>0?d:0, loss=d<0?-d:0;
    avgGain=(avgGain*(period-1)+gain)/period;
    avgLoss=(avgLoss*(period-1)+loss)/period;
    const rs=avgLoss===0?999:(avgGain/avgLoss);
    out[i]=100-(100/(1+rs));
  }
  return out;
}
function atr(high, low, close, period=14){
  const tr=[high[0]-low[0]];
  for(let i=1;i<close.length;i++){
    const a=high[i]-low[i];
    const b=Math.abs(high[i]-close[i-1]);
    const c=Math.abs(low[i]-close[i-1]);
    tr.push(Math.max(a,b,c));
  }
  const out=new Array(close.length).fill(null);
  let sum=0;
  for(let i=0;i<tr.length;i++){
    sum+=tr[i];
    if(i>=period){ sum-=tr[i-period]; out[i]=sum/period; }
    else if(i===period-1){ out[i]=sum/period; }
  }
  const first=out.find(v=>v!==null)??0;
  return out.map(v=>v===null?first:v);
}
function pct(x){ return (x*100).toFixed(2)+"%"; }

function analyzeSymbol(symbol, bars){
  if(bars.length < 260) return {symbol, ok:false, why:"Yetersiz veri (min 260 gün)"};

  const close=bars.map(b=>b.close), high=bars.map(b=>b.high), low=bars.map(b=>b.low), vol=bars.map(b=>b.volume);
  const turnover = close.map((c,i)=>c*vol[i]);

  const EMA20=ema(close,20), EMA50=ema(close,50), RSI14=rsi(close,14), ATR14=atr(high,low,close,14);
  const n=close.length, lastClose=close[n-1];

  const avgTurn20 = turnover.slice(-20).reduce((a,b)=>a+b,0)/20;
  const liquidityOK = avgTurn20 >= 30_000_000;

  const ema50Slope = EMA50[n-1]-EMA50[n-6];
  const trendOK = (lastClose>EMA20[n-1]) && (lastClose>EMA50[n-1]) && (ema50Slope>0);

  const avgVol5 = vol.slice(-5).reduce((a,b)=>a+b,0)/5;
  const avgVol20 = vol.slice(-20).reduce((a,b)=>a+b,0)/20;
  const volRatio = avgVol5/(avgVol20+1e-9);
  const volumeBurst = volRatio>=1.5;

  const prev10 = close.slice(-11,-1);
  const prev10Max = Math.max(...prev10);
  const breakout = lastClose>prev10Max;

  const rsiOK = RSI14[n-1]>=55 && RSI14[n-1]<=70;

  const atr10 = ATR14.slice(-10).reduce((a,b)=>a+b,0)/10;
  const atr30 = ATR14.slice(-30).reduce((a,b)=>a+b,0)/30;
  const volSqueeze = (atr10<atr30) && (ATR14[n-1]>ATR14[n-2]);

  const triggers = [
    ["Hacim patlaması", volumeBurst],
    ["10g kapanış zirvesi kırılımı", breakout],
    ["RSI rejimi 55-70", rsiOK],
    ["Volatilite sıkışması", volSqueeze],
  ];
  const passed = triggers.filter(x=>x[1]).map(x=>x[0]);
  const triggersOK = passed.length>=3;

  // 2 yıllık kanıt: geçmişte benzer setup (breakout+volburst+rsiOK)
  const setupIdx=[];
  for(let i=60;i<n-6;i++){
    const prev = close.slice(i-10,i);
    const br = close[i] > Math.max(...prev);
    const v5 = vol.slice(i-4,i+1).reduce((a,b)=>a+b,0)/5;
    const v20 = vol.slice(i-19,i+1).reduce((a,b)=>a+b,0)/20;
    const vb = (v5/(v20+1e-9))>=1.5;
    const ro = RSI14[i]>=55 && RSI14[i]<=70;
    if(br && vb && ro) setupIdx.push(i);
  }

  const horizon=5;
  const rets=[], dds=[];
  for(const i of setupIdx){
    const entry=close[i];
    const end=Math.min(i+horizon, n-1);
    const window=close.slice(i,end+1);
    const exit=close[end];
    rets.push((exit/entry)-1);
    dds.push((Math.min(...window)/entry)-1);
  }
  const similar=rets.length;
  const successRate = similar ? (rets.filter(r=>r>0).length/similar) : 0;
  const avgRet = similar ? (rets.reduce((a,b)=>a+b,0)/similar) : 0;
  const avgDD = similar ? (dds.reduce((a,b)=>a+b,0)/similar) : 0;

  const proofOK = (similar>=8) && (successRate>=0.60) && (Math.abs(avgDD)<=0.045);

  const stop=0.036, tgt1=0.048, tgt2=0.082;
  const rr = tgt2/stop;

  // Score
  let score=0;
  score += 45*Math.min(1, Math.max(0, successRate));
  score += 25*Math.min(1, Math.max(0, (rr-1)/2));
  score += 20*(trendOK?1:0.3);
  score += 10*(liquidityOK?1:0.3);
  score = Math.round(Math.max(0, Math.min(100, score)));

  const hardOK = liquidityOK && trendOK && triggersOK;
  const signal = (hardOK && proofOK && rr>=2.0 && score>=65) ? "AL" : "BEKLE";

  const reasons=[];
  reasons.push(liquidityOK?`Likidite güçlü (20g ort. ciro ≈ ${Math.round(avgTurn20).toLocaleString("tr-TR")} TL)`:"Likidite filtresi zayıf");
  reasons.push(trendOK?"Trend pozitif (EMA20 & EMA50 üstü, EMA50 eğimi +)":"Trend filtresi zayıf");
  passed.forEach(p=>reasons.push(p));
  reasons.push(`2 yıllık kanıt: ${similar} setup • başarı ${(successRate*100).toFixed(1)}% • ort 1w ${(avgRet*100).toFixed(2)}% • ort ters ${(avgDD*100).toFixed(2)}%`);

  return {
    symbol, ok:true, signal, score,
    lastClose,
    entryRule: `${prev10Max.toFixed(2)} üstünde 60dk kalıcılık`,
    stop, targets:[tgt1,tgt2],
    reasons, proof:{similar, successRate, avgRet, avgDD}
  };
}

const bistFiles=document.getElementById("bistFiles");
const bistRun=document.getElementById("bistRun");
const bistClear=document.getElementById("bistClear");
const bistStatus=document.getElementById("bistStatus");
const bistTop=document.getElementById("bistTop");
const bistDetails=document.getElementById("bistDetails");

bistFiles.addEventListener("change", ()=>{
  bistRun.disabled = !bistFiles.files.length;
  bistStatus.textContent = bistFiles.files.length ? `${bistFiles.files.length} dosya hazır.` : "";
});

bistClear.addEventListener("click", ()=>{
  bistFiles.value="";
  bistRun.disabled=true;
  bistStatus.textContent="";
  bistTop.innerHTML="";
  bistDetails.innerHTML="";
});

bistRun.addEventListener("click", async ()=>{
  const files=[...bistFiles.files];
  if(!files.length) return;
  bistStatus.textContent="Dosyalar okunuyor...";
  const items=[];
  for(const f of files){
    const symbol=f.name.replace(/\.csv$/i,'').toUpperCase();
    const rows=parseCSV(await f.text());
    const bars=rows.map(r=>({
      date:r.date,
      open:toNum(r.open), high:toNum(r.high), low:toNum(r.low),
      close:toNum(r.close), volume:toNum(r.volume)
    })).filter(b=>b.open&&b.high&&b.low&&b.close&&b.volume);
    bars.sort((a,b)=>a.date.localeCompare(b.date));
    items.push({symbol,bars});
  }
  bistStatus.textContent=`Analiz ediliyor... (${items.length} sembol)`;

  const results=items.map(it=>analyzeSymbol(it.symbol, it.bars)).filter(r=>r.ok);
  results.sort((a,b)=>{
    const sa=a.signal==="AL"?0:1, sb=b.signal==="AL"?0:1;
    if(sa!==sb) return sa-sb;
    return b.score-a.score;
  });

  const strong=results.filter(r=>r.signal==="AL" && r.score>=75).slice(0,6);
  const show = strong.length ? strong : results.slice(0,6);

  renderBistTop(show);
  renderBistDetails(show);

  bistStatus.innerHTML = `Tamam. Güçlü AL: <b>${strong.length}</b> • Gösterilen: <b>${show.length}</b>`;
});

function renderBistTop(items){
  if(!items.length){
    bistTop.innerHTML = `<div class="small muted">Aday çıkmadı. Daha çok sembol yükle veya veri güncel değil.</div>`;
    return;
  }
  const rows = items.map(x=>`
    <tr>
      <td><b>${x.symbol}</b></td>
      <td><span class="tag ${x.signal==="AL"?"al":"bekle"}">${x.signal}</span></td>
      <td>${x.score}</td>
      <td>${x.lastClose.toFixed(2)}</td>
      <td class="mono">${x.entryRule}</td>
      <td>${pct(x.stop)}</td>
      <td>${x.targets.map(t=>pct(t)).join(" / ")}</td>
    </tr>
  `).join("");
  bistTop.innerHTML = `
    <table>
      <thead><tr><th>Sembol</th><th>Sinyal</th><th>Skor</th><th>Son</th><th>Giriş</th><th>Stop</th><th>Hedef</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <div class="small muted" style="margin-top:8px">* Emir senin platformunda verilir. Stop/hedef yüzde bazlıdır.</div>
  `;
}
function renderBistDetails(items){
  bistDetails.innerHTML = "";
  for(const x of items){
    const why = x.reasons.map(r=>`<li>${r}</li>`).join("");
    bistDetails.innerHTML += `
      <div class="card">
        <div class="row">
          <div class="grow"><b>${x.symbol}</b> <span class="tag ${x.signal==="AL"?"al":"bekle"}">${x.signal}</span></div>
          <div class="small muted">Skor: <b>${x.score}</b></div>
        </div>
        <div class="grid" style="margin-top:10px">
          <div class="card" style="margin:0">
            <b>İşlem Planı (1 hafta)</b>
            <div class="small muted" style="margin-top:6px">Giriş: <span class="mono">${x.entryRule}</span></div>
            <div class="small muted">Stop: <b>${pct(x.stop)}</b></div>
            <div class="small muted">Hedef: <b>${x.targets.map(t=>pct(t)).join(" / ")}</b></div>
          </div>
          <div class="card" style="margin:0">
            <b>2 Yıllık Kanıt</b>
            <div class="small muted" style="margin-top:6px">
              Setup: <b>${x.proof.similar}</b> • Başarı: <b>${(x.proof.successRate*100).toFixed(1)}%</b><br/>
              Ort 1w: <b>${(x.proof.avgRet*100).toFixed(2)}%</b> • Ort ters: <b>${(x.proof.avgDD*100).toFixed(2)}%</b>
            </div>
          </div>
        </div>
        <div style="margin-top:10px">
          <b>Neden?</b>
          <ol class="small muted">${why}</ol>
        </div>
        <div class="small muted">Uyarı: Kesin kâr yoktur. Stop zorunludur.</div>
      </div>
    `;
  }
}

/* =========================
   Üstteki tek buton: Bilgileri Güncelle
========================= */
async function refreshAll(){
  const btn = document.getElementById("refreshAll");
  btn.disabled = true;
  const old = btn.textContent;
  btn.textContent = "Güncelleniyor...";

  try{
    await refreshMarkets();
    if (bistFiles.files && bistFiles.files.length > 0) {
      bistRun.click();
    }
  } catch(e){
    alert("Güncelleme hatası: " + (e?.message || e));
  } finally {
    btn.textContent = old;
    btn.disabled = false;
  }
}

document.getElementById("refreshAll").addEventListener("click", refreshAll);

// Sayfa açılınca ilk veri çek
refreshMarkets();
</script>
</body>
</html>