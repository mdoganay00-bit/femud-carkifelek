<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Femud KazÄ± Kazan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Poppins", sans-serif;
      background: radial-gradient(circle at top, #f3e5f5 0, #b39ddb 35%, #4a148c 100%);
      color: #f5f0ff;
    }

    .container {
      width: 100%;
      max-width: 420px;
      background: rgba(13, 0, 32, 0.95);
      border-radius: 18px;
      box-shadow: 0 22px 50px rgba(0, 0, 0, 0.8);
      padding: 18px 18px 22px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 10% 0%, rgba(255,255,255,0.04) 0, transparent 45%),
        radial-gradient(circle at 90% 0%, rgba(255,255,255,0.06) 0, transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .inner {
      position: relative;
      z-index: 2;
    }

    h1 {
      margin: 0 0 6px;
      font-size: 24px;
      font-weight: 800;
      color: #f3e5f5;
      text-shadow: 0 3px 8px rgba(0, 0, 0, 0.8);
    }

    .subtitle {
      font-size: 13px;
      color: #d1c4e9;
      margin-bottom: 10px;
    }

    .badge-premium {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ffeb3b, #ff9800);
      color: #3e2723;
      font-weight: 700;
      box-shadow: 0 3px 10px rgba(0,0,0,0.6);
      margin-bottom: 8px;
    }

    .badge-premium span.icon {
      font-size: 13px;
    }

    .field {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #7e57c2;
      background: rgba(9, 0, 26, 0.85);
      color: #fbe9ff;
      padding: 9px 14px;
      font-size: 14px;
      margin-bottom: 8px;
      outline: none;
    }

    .field::placeholder {
      color: #b39ddb;
    }

    .field:focus {
      border-color: #b388ff;
      box-shadow: 0 0 0 2px rgba(179, 136, 255, 0.25);
    }

    .wallet-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #e1bee7;
      margin-bottom: 10px;
    }

    .wallet-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(123, 31, 162, 0.9);
      border: 1px solid rgba(255,255,255,0.15);
      font-size: 11px;
      font-weight: 600;
    }

    .wallet-pill strong {
      color: #ffeb3b;
    }

    .follow-note {
      font-size: 12px;
      font-weight: 600;
      color: #ce93d8;
      margin: 2px 0 10px;
    }

    .scratch-wrapper {
      margin: 0 auto 12px;
      width: 280px;
      height: 180px;
      position: relative;
      border-radius: 14px;
      background: linear-gradient(135deg, #4a148c, #880e4f);
      box-shadow:
        0 10px 25px rgba(0, 0, 0, 0.8),
        0 0 0 2px rgba(255,255,255,0.12);
      overflow: hidden;
    }

    .scratch-inner {
      position: absolute;
      inset: 0;
      padding: 14px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      color: #fff8e1;
      text-align: center;
      z-index: 1;
    }

    .scratch-title {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .scratch-prize {
      font-size: 18px;
      font-weight: 800;
      color: #ffeb3b;
      text-shadow: 0 3px 8px rgba(0,0,0,0.9);
      min-height: 24px;
    }

    .scratch-hint {
      font-size: 11px;
      color: #ffe0b2;
    }

    canvas#scratchCanvas {
      position: absolute;
      inset: 0;
      z-index: 2;
      touch-action: none;
    }

    .btn-primary {
      width: 100%;
      margin-top: 6px;
      padding: 11px 20px;
      border-radius: 999px;
      border: none;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      background: radial-gradient(circle at 20% 0, #ff80ab 0, #e91e63 35%, #ad1457 100%);
      box-shadow: 0 12px 24px rgba(233, 30, 99, 0.7);
      position: relative;
      overflow: hidden;
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(233, 30, 99, 0.8);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: 0 6px 12px rgba(158,158,158,0.6);
    }

    .btn-primary::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 10% 0, rgba(255,255,255,0.35), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
    }

    .limit-info {
      margin-top: 6px;
      font-size: 11px;
      color: #d1c4e9;
    }

    .limit-info strong {
      color: #ffeb3b;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(5, 0, 15, 0.78);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .modal {
      width: 90%;
      max-width: 360px;
      background: #120025;
      border-radius: 16px;
      padding: 16px 16px 18px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.9);
      border: 1px solid rgba(255,255,255,0.15);
      color: #f3e5f5;
      text-align: center;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 6px;
      color: #ffeb3b;
    }

    .modal-prize {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .modal-text {
      font-size: 12px;
      color: #e1bee7;
      margin-bottom: 10px;
    }

    .modal-wallet {
      font-size: 12px;
      color: #ffecb3;
      margin-bottom: 10px;
    }

    .modal button {
      margin-top: 4px;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #7e57c2, #5e35b1);
      color: #fff;
      box-shadow: 0 8px 18px rgba(94, 53, 177, 0.7);
    }

    .modal button:active {
      transform: translateY(1px);
    }

    .confetti-piece {
      position: fixed;
      width: 7px;
      height: 14px;
      top: -10px;
      pointer-events: none;
      opacity: 0.9;
      z-index: 30;
      animation: confettiFall 3.2s linear forwards;
    }

    @keyframes confettiFall {
      0% {
        transform: translate3d(0, 0, 0) rotateZ(0deg);
      }
      100% {
        transform: translate3d(var(--dx), 105vh, 0) rotateZ(720deg);
      }
    }

    @media (max-width: 480px) {
      .container {
        border-radius: 0;
        max-width: 100%;
        min-height: 100vh;
      }
      .scratch-wrapper {
        width: 82vw;
        height: 52vw;
        max-width: 320px;
        max-height: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="inner">
      <div class="badge-premium">
        <span class="icon">âœ¨</span>
        <span>FEMUD PREMIUM KAZI KAZAN</span>
      </div>

      <h1>Femud KazÄ± Kazan</h1>
      <div class="subtitle">
        Ä°smini ve Instagram adresini yaz, kartÄ± kazÄ±, sÃ¼rpriz Femud Ã¶dÃ¼llerini yakala.
      </div>

      <input id="nameInput" class="field" type="text" placeholder="KatÄ±lÄ±mcÄ± adÄ± (zorunlu)" />
      <input id="igInput" class="field" type="text" placeholder="Instagram adresi (@kullanici) (zorunlu)" />

      <div class="wallet-bar">
        <div class="wallet-pill">
          Femud CÃ¼zdan: <strong id="walletDisplay">0 TL / 30 TL</strong>
        </div>
        <div style="font-size: 10px; color: #b39ddb;">GÃ¼ncel bakiyen burada gÃ¶rÃ¼nÃ¼r.</div>
      </div>

      <div class="follow-note">
        Femud_tr Instagram hesabÄ±nÄ± takip etmeyi unutmayÄ±nÄ±z.
      </div>

      <div class="scratch-wrapper">
        <div class="scratch-inner">
          <div class="scratch-title">KazÄ± & Kazan</div>
          <div id="prizeText" class="scratch-prize">KazÄ±maya baÅŸla...</div>
          <div class="scratch-hint">ParmaÄŸÄ±nla ya da mouse ile gri alanÄ± kazÄ±.</div>
        </div>
        <canvas id="scratchCanvas"></canvas>
      </div>

      <button id="scratchBtn" class="btn-primary">YENÄ° KART OLUÅžTUR</button>

      <div class="limit-info">
        Her oyuncu toplamda en fazla <strong>30 TL</strong> Femud CÃ¼zdan bakiyesi kazanabilir.
      </div>
    </div>
  </div>

  <!-- SonuÃ§ / uyarÄ± penceresi -->
  <div id="resultModal" class="modal-backdrop">
    <div class="modal">
      <div id="modalTitle" class="modal-title">Tebrikler!</div>
      <div id="modalPrize" class="modal-prize"></div>
      <div id="modalText" class="modal-text"></div>
      <div id="modalWallet" class="modal-wallet"></div>
      <button id="modalCloseBtn">Tamam</button>
    </div>
  </div>

  <script>
    // Google Apps Script URL'in (CÃœZDAN ve kayÄ±t iÃ§in)
    const API_URL = "https://script.google.com/macros/s/AKfycbyplhi6pahLt8N68gKHnNbBn4cYJhbqLUlM81UHqHYLNzZEUsaSXLE0n5dc91-dc66z/exec";

    const nameInput   = document.getElementById("nameInput");
    const igInput     = document.getElementById("igInput");
    const walletDisplay = document.getElementById("walletDisplay");
    const prizeText   = document.getElementById("prizeText");
    const scratchBtn  = document.getElementById("scratchBtn");

    const modalBackdrop = document.getElementById("resultModal");
    const modalTitle    = document.getElementById("modalTitle");
    const modalPrize    = document.getElementById("modalPrize");
    const modalText     = document.getElementById("modalText");
    const modalWallet   = document.getElementById("modalWallet");
    const modalCloseBtn = document.getElementById("modalCloseBtn");

    const canvas = document.getElementById("scratchCanvas");
    const ctx = canvas.getContext("2d");

    // KazÄ± kazan Ã¶dÃ¼lleri
    const prizes = [
      { label: "BoÅŸ ðŸ˜„", reward: 0 },
      { label: "Tekrar Dene ðŸŽ¯", reward: 0 },
      { label: "5 TL Femud CÃ¼zdan ðŸ’œ", reward: 5 },
      { label: "10 TL Femud CÃ¼zdan ðŸ’œ", reward: 10 },
      { label: "15 TL Femud CÃ¼zdan ðŸ’œ", reward: 15 }
    ];

    const MAX_WALLET = 30;
    const WALLET_KEY = "FEMUD_WALLET_BALANCE";
    const JACKPOT_KEY = "FEMUD_WALLET_JACKPOT_AT";

    let currentPrize = null;
    let isScratching = false;
    let alreadyRevealed = false;

    function loadWallet() {
      // 24 saat kontrollÃ¼ bÃ¼yÃ¼k Ã¶dÃ¼l sÃ¼resi
      const jackpotAt = Number(localStorage.getItem(JACKPOT_KEY) || "0");
      if (jackpotAt) {
        const diff = Date.now() - jackpotAt;
        if (diff > 24 * 60 * 60 * 1000) {
          // 24 saat geÃ§tiyse bakiyeyi sÄ±fÄ±rla
          localStorage.removeItem(JACKPOT_KEY);
          localStorage.setItem(WALLET_KEY, "0");
        }
      }

      const stored = Number(localStorage.getItem(WALLET_KEY) || "0");
      updateWalletDisplay(stored);
      return stored;
    }

    function updateWalletDisplay(amount) {
      walletDisplay.textContent = amount + " TL / " + MAX_WALLET + " TL";
    }

    let walletBalance = loadWallet();

    function launchConfetti() {
      const colors = ["#ff5252", "#ffeb3b", "#69f0ae", "#40c4ff", "#ff80ab", "#b39ddb"];
      for (let i = 0; i < 80; i++) {
        const el = document.createElement("div");
        el.className = "confetti-piece";
        el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        const left = Math.random() * 100;
        const dx   = (Math.random() - 0.5) * 220 + "px";
        const delay = Math.random() * 0.25;

        el.style.left = left + "vw";
        el.style.setProperty("--dx", dx);
        el.style.animationDelay = delay + "s";

        document.body.appendChild(el);
        setTimeout(() => el.remove(), 3500);
      }
    }

    function sendToSheet(name, ig, prizeLabel, reward, newBalance) {
      try {
        fetch(API_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            source: "scratch",
            game: "Femud KazÄ± Kazan",
            name: name,
            ig: ig,
            prize: prizeLabel,
            reward: reward,
            walletBalance: newBalance
          })
        }).catch(() => {});
      } catch (err) {
        console.log("KayÄ±t gÃ¶nderilemedi", err);
      }
    }

    function openModal(title, prizeLabel, message, walletMsg) {
      modalTitle.textContent = title;
      modalPrize.textContent = prizeLabel || "";
      modalText.textContent = message || "";
      modalWallet.textContent = walletMsg || "";
      modalBackdrop.style.display = "flex";
    }

    modalCloseBtn.addEventListener("click", () => {
      modalBackdrop.style.display = "none";
    });

    function setupCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;

      ctx.globalCompositeOperation = "source-over";
      const grd = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      grd.addColorStop(0, "#b0bec5");
      grd.addColorStop(1, "#78909c");
      ctx.fillStyle = grd;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = "rgba(255,255,255,0.25)";
      ctx.font = "bold 18px system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("KAZI & KAZAN", canvas.width / 2, canvas.height / 2);

      ctx.globalCompositeOperation = "destination-out";

      alreadyRevealed = false;
      prizeText.textContent = "KazÄ±maya baÅŸla...";
    }

    function pickPrize() {
      // Rastgele Ã¶dÃ¼l
      const p = prizes[Math.floor(Math.random() * prizes.length)];
      currentPrize = p;
      prizeText.textContent = "SÃ¼rpriz hazÄ±r!";
    }

    function pointerPos(e) {
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      if (e.touches && e.touches.length > 0) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      return {
        x: clientX - rect.left,
        y: clientY - rect.top
      };
    }

    function scratchMove(e) {
      if (!isScratching || alreadyRevealed) return;
      e.preventDefault();

      const pos = pointerPos(e);
      const radius = 18;

      ctx.beginPath();
      ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
      ctx.fill();

      // YaklaÅŸÄ±k ne kadar alan aÃ§Ä±lmÄ±ÅŸ kontrolÃ¼
      const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
      let transparent = 0;
      for (let i = 3; i < pixels.length; i += 4) {
        if (pixels[i] === 0) transparent++;
      }
      const ratio = transparent / (pixels.length / 4);

      if (ratio > 0.6) {
        revealPrize();
      }
    }

    function revealPrize() {
      if (alreadyRevealed) return;
      alreadyRevealed = true;
      isScratching = false;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (!currentPrize) pickPrize();
      const { label, reward } = currentPrize;

      prizeText.textContent = label;

      const rawName = nameInput.value.trim();
      let rawIg = igInput.value.trim();
      if (!rawName || !rawIg) {
        openModal(
          "Bilgi",
          label,
          "Ã–dÃ¼lÃ¼nÃ¼zÃ¼ kaydedebilmemiz iÃ§in lÃ¼tfen adÄ±nÄ±zÄ± ve Instagram adresinizi yukarÄ±ya eksiksiz girin.",
          ""
        );
        return;
      }
      if (!rawIg.startsWith("@")) rawIg = "@" + rawIg;
      const igClean = rawIg.replace(/^@/, "").trim();

      let infoText = "";
      let title = "Tebrikler!";
      let walletMsg = "";

      let addAmount = reward || 0;

      // Tekrar dene / BoÅŸ durumlarÄ±
      if (label.includes("BoÅŸ")) {
        infoText = "Bu kartta TL kazanamadÄ±nÄ±z ama Femud ÅŸans oyunlarÄ±na devam edebilirsiniz.";
      } else if (label.includes("Tekrar")) {
        infoText = "Bu kartta ek TL kazanmadÄ±nÄ±z, dilerseniz yeni kart oluÅŸturup tekrar deneyebilirsiniz.";
      }

      // CÃ¼zdan gÃ¼ncellemesi
      let newBalance = walletBalance;

      if (addAmount > 0) {
        let target = walletBalance + addAmount;
        if (target >= MAX_WALLET) {
          target = MAX_WALLET;
          // BÃ¼yÃ¼k Ã¶dÃ¼le ulaÅŸtÄ±ysa zaman damgasÄ± koy
          if (!localStorage.getItem(JACKPOT_KEY)) {
            localStorage.setItem(JACKPOT_KEY, Date.now().toString());
          }
          title = "BÃœYÃœK Ã–DÃœLE ULAÅžTINIZ!";
          infoText =
            "Femud CÃ¼zdan bakiyeniz 30 TL'ye ulaÅŸtÄ±. " +
            "30 TL indirim hakkÄ±nÄ±zÄ± kullanmak iÃ§in 24 saat iÃ§inde Femud alÄ±ÅŸveriÅŸinizi yapÄ±p sipariÅŸ sÄ±rasÄ±nda bu hakkÄ±nÄ±zÄ± belirtiniz. " +
            "24 saat iÃ§inde kullanÄ±lmayan bakiyeler sÄ±fÄ±rlanÄ±r.";
        } else {
          if (!infoText) {
            infoText =
              "Femud CÃ¼zdan bakiyenize " +
              addAmount +
              " TL eklendi. Toplam bakiyenizi aÅŸaÄŸÄ±da gÃ¶rebilirsiniz.";
          }
        }

        newBalance = target;
        walletBalance = newBalance;
        localStorage.setItem(WALLET_KEY, String(newBalance));
      }

      updateWalletDisplay(walletBalance);

      if (addAmount > 0) {
        walletMsg = "GÃ¼ncel Femud CÃ¼zdan bakiyeniz: " + walletBalance + " TL (maksimum 30 TL).";
      } else {
        walletMsg = "Femud CÃ¼zdan bakiyeniz: " + walletBalance + " TL.";
      }

      // Google Sheet'e gÃ¶nder
      sendToSheet(rawName, igClean, label, addAmount, walletBalance);

      // Konfeti sadece Ã¶dÃ¼l kazananlarda patlasÄ±n
      if (addAmount > 0) {
        launchConfetti();
      }

      openModal(title, label, infoText, walletMsg);
    }

    function startScratch(e) {
      if (!currentPrize) return;
      if (walletBalance >= MAX_WALLET) {
        // Zaten 30 TL'de ise bilgilendir
        openModal(
          "BÃ¼yÃ¼k Ã–dÃ¼le UlaÅŸtÄ±nÄ±z",
          "",
          "Femud CÃ¼zdan bakiyeniz zaten 30 TL. Bu hakkÄ±nÄ±zÄ± 24 saat iÃ§inde kullanmayÄ± unutmayÄ±n.",
          "Yeni kazÄ± kazan denemeleri ÅŸu anda ek TL kazandÄ±rmaz."
        );
        return;
      }
      isScratching = true;
      scratchMove(e);
    }

    function endScratch() {
      isScratching = false;
    }

    canvas.addEventListener("mousedown", startScratch);
    canvas.addEventListener("touchstart", startScratch, { passive: false });
    canvas.addEventListener("mousemove", scratchMove);
    canvas.addEventListener("touchmove", scratchMove, { passive: false });
    window.addEventListener("mouseup", endScratch);
    window.addEventListener("touchend", endScratch);

    scratchBtn.addEventListener("click", () => {
      // Yeni kart oluÅŸtur
      setupCanvas();
      pickPrize();
    });

    // Ä°lk aÃ§Ä±lÄ±ÅŸta kart ve tuval ayarÄ±
    window.addEventListener("load", () => {
      setupCanvas();
      pickPrize();
    });
  </script>
</body>
</html>